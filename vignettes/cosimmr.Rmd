---
title: "Stable Isotope Mixing Models with Covariates in R using cosimmr"
author: "Emma Govan and Andrew Parnell"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette:
  toc: true
vignette: >
  %\VignetteIndexEntry{cosimmr}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---


## Introduction

`cosimmr` is a package in R designed for running Stable Isotope Mixing Models in
R, using Fixed Form Variational Bayes. The aim of this vignette is to allow users
to quickly learn how to use the package and giving examples of all the 
features within the package.
If you find any bugs in the software, or have new features which you think would be 
useful, please add this to the [Github issues page](https://github.com/emmagovan/cosimmr/issues)

## Installation of the `cosimmr` package

First, start Rstudio and find the window with the command prompt (the symbol `>`). Type

```{r,eval = FALSE}
install.packages("cosimmr")
```
It may ask you to pick your nearest CRAN mirror (the nearest site which hosts R packages). You will then see some activity on the screen as the `cosimmr` package and the other packages it uses are downloaded. The final line should then read: 

`package 'cosimmr' successfully unpacked and MD5 sums checked`

You then need to load the package. Type

```{r,eval = FALSE}
library(cosimmr)
```

This will load the `cosimmr` package and all the associated packages. Youâ€™ll need to type the `library(cosimmr)` command every time you start R.


There is some sample data sets (from ADD PAPER REF) available within cosimmr. 
Use the following command to access one.
```{r}
data(geese_data_day1)
```

This data can then be loaded into cosimmr using the function `cosimmr_load`

```{r}
cosimmr_1 <- with(
  geese_data_day1,
  cosimmr_load(
    formula = mixtures ~ c(1,2,3,3,2,3,2,1,2),
    source_names = source_names,
    source_means = source_means,
    source_sds = source_sds,
    correction_means = correction_means,
    correction_sds = correction_sds,
    concentration_means = concentration_means
  )
)



```

An isospace plot can be generated using this data

```{r}
plot(cosimmr_1)
```

The data can then be run through `cosimmr_ffvb`, the main function of the `cosimmr` 
package.
```{r}
cosimmr_1_out = cosimmr_ffvb(cosimmr_1)
```


The output of this can be plotted, using the plot function. There are several different
options available in the plot function
```{r}
plot(cosimmr_1_out, type = c("isospace", "beta_histogram", "p_ind"), ind = c(1,7))
```

Predictions
```{r}
cosimmr_predict(cosimmr_1_out, c(1,3))

cosimmr_predict(cosimmr_1_out, c(1))

newdata = matrix(c(1,3), ncol = 1)

a<-cosimmr_predict(cosimmr_1_out, matrix(c(1,3), ncol = 1))

cosimmr_predict(cosimmr_1_out, as.matrix(1))
```







Categorical variables also work
```{r}
colour_cat = c("red", "green", "blue", "red", "red", "red", "blue", "green", "blue")

# data(geese_data)
# cosimmr_2 <- with(
#   geese_data,
#   cosimmr_load(
#     formula = mixtures ~ groups,
#     source_names = source_names,
#     source_means = source_means,
#     source_sds = source_sds,
#     correction_means = correction_means,
#     correction_sds = correction_sds,
#     concentration_means = concentration_means
#   )
# )

cosimmr_2 <-cosimmr_load(
    formula = geese_data_day1$mixtures ~ colour_cat,
    source_names = geese_data_day1$source_names,
    source_means = geese_data_day1$source_means,
    source_sds = geese_data_day1$source_sds,
    correction_means = geese_data_day1$correction_means,
    correction_sds = geese_data_day1$correction_sds,
    concentration_means = geese_data_day1$concentration_means
  )

cosimmr_2_out = cosimmr_ffvb(cosimmr_2)

library(microbenchmark)

microbenchmark(cosimmr = cosimmr_ffvb(cosimmr_2),
               mixsiar = run_model(run="short", mix, source, discr, model_filename, alpha.prior=1), times = 2L)



cosimmr_predict(cosimmr_1_out, as.matrix("red"))
```



## Mixsiar comparison


```{r}
library(MixSIAR)
mix.filename <- system.file("extdata", "geese_consumer.csv", package = "MixSIAR")
mix <- load_mix_data(filename=mix.filename,
					 iso_names=c("d13C","d15N"),
					 factors="Group",
					 fac_random=FALSE,
					 fac_nested=FALSE,
					 cont_effects=NULL)

# Load source data
source.filename <- system.file("extdata", "geese_sources.csv", package = "MixSIAR")
source <- load_source_data(filename=source.filename,
						   source_factors=NULL,
						   conc_dep=TRUE,
						   data_type="means",
						   mix)

# Load discrimination/TDF data
discr.filename <- system.file("extdata", "geese_discrimination.csv", package = "MixSIAR")
discr <- load_discr_data(filename=discr.filename, mix)

# Make isospace plot
plot_data(filename="isospace_plot",
		  plot_save_pdf=TRUE,
		  plot_save_png=FALSE,
		  mix,source,discr)

# Calculate standardized convex hull area
if(mix$n.iso==2) calc_area(source=source,mix=mix,discr=discr)

# Plot your prior
plot_prior(alpha.prior=1,source)

# Define model structure and write JAGS model file
model_filename <- "MixSIAR_model.txt"
resid_err <- TRUE
process_err <- FALSE
write_JAGS_model(model_filename, resid_err, process_err, mix, source)

# Run the JAGS model ("test" first, then "short")
jags.1 <- run_model(run="test", mix, source, discr, model_filename, alpha.prior=1)
#jags.1 <- run_model(run="short", mix, source, discr, model_filename, alpha.prior=1)

# Process diagnostics, summary stats, and posterior plots
output_JAGS(jags.1, mix, source)

#Stats from Mixsiar
```


Alligator
```{r}
library(tidyr)
library(ggplot2)
mix.filename <- system.file("extdata", "alligator_consumer.csv", package = "MixSIAR")
source.filename <- system.file("extdata", "alligator_sources_simplemean.csv", package = "MixSIAR")
discr.filename <- system.file("extdata", "alligator_TEF.csv", package = "MixSIAR")

# load mix data (cont effect of Length, random effect of Individual)
mix <- load_mix_data(filename=mix.filename,
                          iso_names=c("d13C","d15N"),
                          factors="ID",
                          fac_random=TRUE,
                          fac_nested=NULL,
                          cont_effects="Length")

# load source data
source <- load_source_data(filename=source.filename,
                         source_factors=NULL,
                         conc_dep=FALSE,
                         data_type="means",
                         mix=mix)

# load TEF data
discr <- load_discr_data(filename=discr.filename, mix=mix)

# isospace plot
plot_data(filename="isospace_plot",
        plot_save_pdf=TRUE,
        plot_save_png=FALSE,
        mix, source, discr)

# Define model structure and write JAGS model file
model_filename <- paste0("MixSIAR_model_cont_ind.txt")
resid_err <- FALSE
process_err <- TRUE
write_JAGS_model(model_filename, resid_err, process_err, mix, source)

# Run the JAGS model
jags.mod <- run_model(run="short", mix, source, discr, model_filename, alpha.prior=1)

# Process diagnostics, summary stats, and posterior plots
output_JAGS(jags.mod, mix, source)
graphics.off()
```





#Isopod Examples
```{r}
mix.filename <- system.file("extdata", "isopod_consumer.csv", package = "MixSIAR")
mix <- load_mix_data(filename=mix.filename,
					 iso_names=c("c16.4w3","c18.2w6","c18.3w3","c18.4w3","c20.4w6","c20.5w3","c22.5w3","c22.6w3"),
					 factors="Site",
					 fac_random=TRUE,
					 fac_nested=FALSE,
					 cont_effects=NULL)

# Load source data
source.filename <- system.file("extdata", "isopod_sources.csv", package = "MixSIAR")
source <- load_source_data(filename=source.filename,
						   source_factors=NULL,
						   conc_dep=FALSE,
						   data_type="means",
						   mix)

# Load discrimination/TDF data
discr.filename <- system.file("extdata", "isopod_discrimination.csv", package = "MixSIAR")
discr <- load_discr_data(filename=discr.filename, mix)

# Make isospace plot
plot_data(filename="isospace_plot",
		  plot_save_pdf=TRUE,
		  plot_save_png=FALSE,
		  mix,source,discr)

# Plot your prior
plot_prior(alpha.prior=1,source)

# Define model structure and write JAGS model file
model_filename <- "MixSIAR_model.txt"
resid_err <- TRUE
process_err <- FALSE
write_JAGS_model(model_filename, resid_err, process_err, mix, source)

# Run the JAGS model ("test" first, then "normal")
jags.1 <- run_model(run="test", mix, source, discr, model_filename,alpha.prior=1)

## "normal" took my laptop ~60 minutes to run
#jags.1 <- run_model(run="normal", mix, source, discr, model_filename,alpha.prior=1)

# Process diagnostics, summary stats, and posterior plots
output_JAGS(jags.1, mix, source)
```


Example with categorical and numeric
```{r}
colour_cat = c("red", "green", "blue", "red", "red", "red", "blue", "green", "blue")
letter_cat = c("A", "B", "B", "D", "A", "c", "E", "A", "E")
numeric_cov = c(1,3,5,7,4,3,1,2,7)

cosimmr_3 <-cosimmr_load(
    formula = geese_data_day1$mixtures ~ colour_cat + letter_cat + numeric_cov,
    source_names = geese_data_day1$source_names,
    source_means = geese_data_day1$source_means,
    source_sds = geese_data_day1$source_sds,
    correction_means = geese_data_day1$correction_means,
    correction_sds = geese_data_day1$correction_sds,
    concentration_means = geese_data_day1$concentration_means
  )

cosimmr_3_out = cosimmr_ffvb(cosimmr_3)
```





CONVERTING CATEGORICAL DATA

```{r}
#Think I need to convert categorical data to factor first - but only categorical data
#And need to make sure numeric is numeric
#And then run this
#And then still need to figure out predictions but it might work via that
#attr(,"contrasts")$factor.colour_cat bit

c_df = cbind(geese_data_day1$mixtures, data.frame(colour_cat = colour_cat, letter_cat = letter_cat, numeric_cov = numeric_cov))

for(i in 1:ncol(c_df)){
  if(class(c_df[,i]) == "character"){c_df[,i] = as.factor(c_df[,i])}
}

 model.matrix(as.matrix(c_df[,1:2]) ~ colour_cat + numeric_cov + letter_cat, data=c_df, 
              contrasts.arg = lapply(c_df[sapply(c_df, is.factor)], 
                                     contrasts, contrasts=FALSE))
 

```


















